<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
        <title>AJ Security æ¡†æ¶-é“¾è·¯è·Ÿè¸ª</title>
        <meta name="description" content="å®ç”¨çš„ Java Web å®‰å…¨åº“ã€‚é“¾è·¯è·Ÿè¸ª"/>
        <meta name="keywords" content="security, xss, csrf, captcha, é“¾è·¯è·Ÿè¸ª"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="/asset/style/main.css"/>
        <link rel="icon" type="image/png" href="/asset/favicon.ico"/>
        <script src="/asset/common.js"></script>
        <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?950ba5ba1f1fe4906c3b4cf836080f03";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
        </script>
    </head>
    <body>
        <nav>
            <div>
                <div class="links">
                    <a href="/">ğŸ  é¦–é¡µ</a>
                    | âš™ï¸ æºç :
                    <a target="_blank" href="https://github.com/lightweight-component/aj-security">Github</a>/<a target="_blank" href="https://gitcode.com/lightweight-component/aj-security">Gitcode</a>
                    |
                    <a href="/">è‹±æ–‡ç‰ˆæœ¬</a>
                </div>
                <h1>AJ Security</h1>
                <h3>ç”¨æˆ·æ‰‹å†Œ</h3>
            </div>
        </nav>
        <div>
            <menu>
                <ul>
                    <li class="selected">
                        <a href="/cn">é¦–é¡µ</a>
                    </li>
                    <li>
                        <a href="/install-cn">å®‰è£…ä¸é…ç½®</a>
                    </li>
                </ul>
                <h3>HTTP Web å®‰å…¨</h3>
                <ul>
                    <li>
                        <a href="/http/http-referer-cn">HTTP Referer æ ¡éªŒ</a>
                    </li>
                    <li>
                       <a href="/http/timestamp-cn">æ—¶é—´æˆ³åŠ å¯† Token æ ¡éªŒ</a>
                    </li>
                     <li>
                       <a href="/http/paramssign-cn">è¯·æ±‚å‚æ•°é˜²ç¯¡æ”¹</a>
                    </li>
                    <li>
                       <a href="/http/ip-list-cn">IP ç™½åå•/é»‘åå•</a>
                    </li>
                     <li>
                       <a href="/http/nonrepeatsubmit-cn">é˜²æ­¢é‡å¤æäº¤æ•°æ®</a>
                    </li>
                </ul>
                <h3>ä¸€èˆ¬æ€§ Web æ ¡éªŒ</h3>
                <ul>
                      <li>
                           <a href="/classic/xss-cn">é˜²æ­¢ XSS è·¨ç«™æ”»å‡»</a>
                      </li>
                      <li>
                           <a href="/classic/crlf-cn">é˜²æ­¢ CRLF æ”»å‡»</a>
                      </li>
                </ul>

                <h3>éªŒè¯ç  Captcha æœºåˆ¶</h3>
                <ul>
                    <li><a href="/captcha/img-captcha-cn">å›¾ç‰‡éªŒè¯ç </a></li>
                    <li><a href="/captcha/google-cn">åŸºäº Google çš„éªŒè¯ç </a></li>
                    <li><a href="/captcha/cf-cn">åŸºäº CloudFlare çš„éªŒè¯ç </a></li>
                </ul>
                <h3>HTTP æ ‡å‡†è®¤è¯</h3>
                <ul>
                    <li><a href="/auth/http-basic-auth-cn">HTTP Basic Auth è®¤è¯</a></li>
                    <li><a href="/auth/http-digest-auth-cn">HTTP Digest Auth è®¤è¯</a></li>
                </ul>
                <h3>API æ¥å£åŠŸèƒ½</h3>
                <ul>
                    <li><a href="/api/limit-cn">é™æµé™æ¬¡æ•°</a></li>
                </ul>
                <h3>å…¶ä»–å®ç”¨åŠŸèƒ½</h3>
                <ul>
                    <li><a href="/misc/desensitize-cn">å®ä½“å­—æ®µè„±æ•</a></li>
                    <li><a href="/misc/encryption-api-cn">API æ¥å£åŠ è§£å¯†</a></li>
                    <li><a href="/misc/trace-id-cn">é“¾è·¯è·Ÿè¸ªè®°å½•</a></li>
                </ul>
            </menu>
            <article>
                <h1>é“¾è·¯è·Ÿè¸ª</h1>
<p>SpringBoot ä¸ SLF4j çš„ç»“åˆå¯ä»¥å¸®åŠ©æˆ‘ä»¬è½»æ¾å®ç°é“¾è·¯è·Ÿè¸ªåŠŸèƒ½ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯è¯Šæ–­æ€§ã€‚
é“¾è·¯è·Ÿè¸ªåŠŸèƒ½èƒ½å¤Ÿè·Ÿè¸ªç³»ç»Ÿä¸­çš„è¯·æ±‚é“¾è·¯ï¼Œå¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿè¯Šæ–­å’Œè§£å†³é—®é¢˜ã€‚
åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ SpringBoot å’Œ SLF4j å®ç°é“¾è·¯è·Ÿè¸ªåŠŸèƒ½ã€‚</p>
<p>ä¸è°ˆ Zipkinï¼ŒSkyWalking ç­‰å¼€æºé“¾è·¯è·Ÿè¸ªç³»ç»Ÿï¼Œå’±ä»¬é€šè¿‡è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªç®€å•çš„é“¾è·¯è·Ÿè¸ªåŠŸèƒ½ï¼Œå…¶å®ä¸ºçš„å°±æ˜¯æé«˜è‡ªå·±ã€‚
å› ä¸ºæ˜¯é€šè¿‡æ—¥å¿—çš„æ–¹å¼è®°å½•é“¾è·¯ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ°è‡ªå·±çš„ç³»ç»Ÿä¸­ã€‚ä¸ºä»€ä¹ˆéœ€è¦é“¾è·¯è·Ÿè¸ªåŠŸèƒ½å‘¢ï¼Ÿ</p>
<ol>
<li>æé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯è¯Šæ–­æ€§ï¼šé€šè¿‡é“¾è·¯è·Ÿè¸ªï¼Œå¯ä»¥è·Ÿè¸ªç³»ç»Ÿä¸­çš„è¯·æ±‚é“¾è·¯ï¼Œäº†è§£æœåŠ¡ä¹‹é—´çš„äº¤äº’å’Œå»¶è¿Ÿï¼Œå¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿè¯Šæ–­å’Œè§£å†³é—®é¢˜ã€‚</li>
<li>ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼šé€šè¿‡é“¾è·¯è·Ÿè¸ªï¼Œå¯ä»¥åˆ†ææœåŠ¡é—´çš„ä¾èµ–å…³ç³»å’Œæ€§èƒ½é—®é¢˜ï¼Œä¼˜åŒ–ç³»ç»Ÿçš„è°ƒç”¨é“¾è·¯å’Œèµ„æºåˆ©ç”¨ï¼Œæé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œååé‡ã€‚</li>
<li>å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯é æ€§ï¼šé€šè¿‡é“¾è·¯è·Ÿè¸ªï¼Œå¯ä»¥ç›‘æ§ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µå’Œå¼‚å¸¸æƒ…å†µï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³ç³»ç»Ÿä¸­çš„æ¼æ´å’Œæ•…éšœï¼Œå¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚</li>
<li>è¾…åŠ©ç³»ç»Ÿè®¾è®¡å’Œå¼€å‘ï¼šé€šè¿‡é“¾è·¯è·Ÿè¸ªï¼Œå¯ä»¥è¾…åŠ©ç³»ç»Ÿè®¾è®¡å’Œå¼€å‘ï¼Œäº†è§£ç³»ç»Ÿçš„æ¶æ„å’Œæµç¨‹ï¼Œä¼˜åŒ–ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°ï¼Œæé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
</ol>
<p>ä¸ºäº†å”¯ä¸€åœ°æ ‡è®°æ¯ä¸ªè¯·æ±‚ï¼Œç”¨æˆ·å°†ä¸Šä¸‹æ–‡ä¿¡æ¯æ”¾å…¥ MDC (Mapped Diagnostic Context çš„ç¼©å†™)ä¸­ï¼ŒMDC é€šè¿‡<code>ThreadLocal</code>
æ¥å­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå®‰å…¨é—®é¢˜ã€‚</p>
<h2>åŠ¨æ‰‹å®ç°</h2>
<p>è‡ªå®šä¹‰è¿‡æ»¤å™¨<code>Filter</code>ï¼Œè¯¥ Filter çš„ä½œç”¨æ˜¯ç”¨æ¥åœ¨è¯·æ±‚åˆ°æ¥æ—¶è·å–<code>traceId</code>æˆ–è€…ç”Ÿæˆä¸€ä¸ª<code>traceId</code>å€¼ã€‚</p>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.slf4j.MDC;
import org.springframework.stereotype.Component;
import org.springframework.util.AlternativeJdkIdGenerator;
import org.springframework.util.StringUtils;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;

@WebFilter(&quot;/**&quot;)
@Component
@Slf4j
public class TraceXFilter implements Filter {
    final static String TRACE_KEY = &quot;traceId&quot;;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) request;
        // é€šè¿‡è¯·æ±‚headerè·å–è‡ªå®šä¹‰çš„traceIdï¼Œæ²¡æœ‰åˆ™ç³»ç»Ÿç”Ÿæˆ
        String traceId = req.getHeader(&quot;x-trace&quot;);

        if (!StringUtils.hasLength(traceId))
            traceId = getUUID();

        // å°†å½“å‰è¯·æ±‚çš„traceIdå­˜å…¥åˆ°MDCä¸­
        MDC.put(TRACE_KEY, traceId);

        log.info(&quot;è¯·æ±‚: {}&quot;, req.getServletPath());
        chain.doFilter(request, response);
    }
}
</code></pre>
<p>æ¥ä¸‹æ¥æ˜¯ logback-spring.xml æ—¥å¿—è¿›è¡Œé…ç½®ã€‚</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration scan=&quot;true&quot;&gt;
    &lt;contextName&gt;pack-trace&lt;/contextName&gt;
    &lt;property name=&quot;DEFAULT_PATTERN&quot; value=&quot;%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %logger Line:%-3L - %msg%n&quot;/&gt;
    &lt;!--æ³¨æ„è¿™é‡Œçš„traceXIdå°±æ˜¯æˆ‘ä»¬å¾€MDCä¸­å­˜å…¥çš„keyäº†ï¼Œé€šè¿‡%X{traceXId}è·å–å”¯ä¸€æ ‡è¯†--&gt;
    &lt;property name=&quot;TRACEX_PATTERN&quot;
              value=&quot;%green(%d{yyyy-MM-dd HH:mm:ss.SSS}) %highlight(%-5level) [%yellow(%thread)] %logger Line:%-3L traceId:ã€%red(%X{traceXId})ã€‘ - %msg%n&quot;/&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;${DEFAULT_PATTERN}&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;appender name=&quot;TRACEX&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;${TRACEX_PATTERN}&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;logger name=&quot;com.pack.tracex.test&quot; additivity=&quot;false&quot; level=&quot;INFO&quot;&gt;
        &lt;appender-ref ref=&quot;TRACEX&quot;&gt;&lt;/appender-ref&gt;
    &lt;/logger&gt;
    &lt;springProfile name=&quot;dev&quot;&gt;
        &lt;root level=&quot;INFO&quot;&gt;
            &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
        &lt;/root&gt;
    &lt;/springProfile&gt;
&lt;/configuration&gt;
</code></pre>
<p>æœ‰äº†ä¸Šé¢çš„æ—¥å¿—é…ç½®ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥éšæ„å†™ä¸ªæ¥å£è¿›è¡Œæµ‹è¯•ã€‚è®¿é—®æ¥å£ï¼Œæ§åˆ¶å°è¾“å‡º</p>
<pre><code>2023-12-06 15:18:11.685 INFO  [http-nio-8099-exec-2] com.pack.tracex.test.TraceXFilter Line:40  traceId:ã€137FEC312666479A98A6433BA80DE951ã€‘ - è¯·æ±‚: /tracex
2023-12-06 15:18:11.699 INFO  [http-nio-8099-exec-2] com.pack.tracex.test.TraceController Line:28  traceId:ã€137FEC312666479A98A6433BA80DE951ã€‘ - start uri: /tracex
2023-12-06 15:18:11.774 DEBUG [http-nio-8099-exec-2] org.hibernate.SQL Line:135 traceId:ã€137FEC312666479A98A6433BA80DE951ã€‘ - select u1_0.id,u1_0.age,u1_0.email,u1_0.id_no,u1_0.name,u1_0.pwd from users u1_0 where u1_0.id_no=?
2023-12-06 15:18:11.787 INFO  [http-nio-8099-exec-2] com.pack.tracex.test.TraceController Line:31  traceId:ã€137FEC312666479A98A6433BA80DE951ã€‘ - end uri: /tracex
</code></pre>
<p>æ—¥å¿—ä¸­è¾“å‡ºäº† traceIdï¼›å½“ç¨‹åºå‡ºç°é—®é¢˜éœ€è¦è°ƒè¯•æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ª traceId è¿›è¡Œè·Ÿè¸ªè°ƒè¯•ã€‚</p>
<p><img src="/asset/imgs/trace-id-log.jpg" alt=""></p>
<p>åˆ°è¿™æˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªéå¸¸ç®€å•çš„é“¾è·¯è·Ÿè¸ªåŠŸèƒ½ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°†æ¯ä¸€ä¸ªè¯·æ±‚ç”Ÿæˆçš„ traceId è¿”å›åˆ°å®¢æˆ·ç«¯ï¼Œå¸®åŠ©æ’æŸ¥é—®é¢˜ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>ResponseBodyAdvice</code>å¯¹æ¥å£æ•°æ®è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ï¼Œå°† traceId ç»Ÿè®¡çš„æ·»åŠ åˆ°è¿”å›çš„ç»“æœä¸­ã€‚</p>
<h2>è‡ªå®šä¹‰ ResponseBodyAdvice ç»Ÿä¸€å¤„ç†è¿”å›å€¼</h2>
<pre><code class="language-java">
@RestControllerAdvice
public class PackResponseBodyAdvice implements ResponseBodyAdvice&lt;Object&gt; {
    @Resource
    private ObjectMapper objectMapper;

    @Override
    public boolean supports(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType) {
        return !returnType.getParameterType().equals(R.class);
    }

    @Override
    public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType,
                                  Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType, ServerHttpRequest request,
                                  ServerHttpResponse response) {
        if (body instanceof String) {
            try {
                return this.objectMapper.writeValueAsString(R.success(response, MDC.get(TraceX.TRACE_KEY)));
            } catch (JsonProcessingException e) {
                e.printStackTrace();
            }
        }
        if (body instanceof ResponseEntity&lt;?&gt; entity) {
            return R.success(entity.getBody(), MDC.get(TraceX.TRACE_KEY));
        }
        return R.success(body, MDC.get(TraceX.TRACE_KEY));
    }

}
</code></pre>
<p>å†æ¬¡è®¿é—®æ¥å£è¿”å›å¦‚ä¸‹ç»“æœï¼š</p>
<p><img src="/asset/imgs/trace-id-result.jpg" alt=""></p>
<p>è¿”å›çš„ç»“æœåŒ…å«äº†<code>traceId</code>ï¼Œå¦‚æœå¯¹æ¥å£æˆ–è€…æ•°æ®æœ‰é—®é¢˜éœ€è¦æ’æŸ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿ç€è¿™ä¸ª<code>traceId</code>åˆ°æ—¥å¿—ä¸­è¿›è¡ŒæŸ¥çœ‹äº†ã€‚</p>

            </article>
        </div>
        <footer>
             AJ Securityï¼Œå¼€æºæ¡†æ¶ <a href="https://framework.ajaxjs.com" target="_blank">AJ-Framework</a> çš„ä¸€éƒ¨åˆ†ã€‚è”ç³»æ–¹å¼ï¼š
             frank@ajaxjs.comï¼Œ<a href="https://blog.csdn.net/zhangxin09" target="_blank">ä½œè€…åšå®¢</a>
             <br />
             <br />
             Copyright Â© 2025 Frank Cheung. All rights reserved.
         </footer>
    </body>
</html>